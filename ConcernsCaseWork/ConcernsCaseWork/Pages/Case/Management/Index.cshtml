@page "/case/{urn:long}/management"
@model ConcernsCaseWork.Pages.Case.Management.IndexPageModel
@using ConcernsCaseWork.Extensions
@using ConcernsCaseWork.Models.CaseActions
@using ConcernsCaseWork.Service.Status;
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using NetEscapades.AspNetCore.SecurityHeaders

@{
	ViewData["Title"] = "Case management";
	var nonce = HttpContext.GetNonce();
}

<div class="govuk-width-container">
    <partial name="_BannerError" />

    @if (!string.IsNullOrEmpty((string)TempData.Peek("Error.Message")))
    {
        <partial name="_Error" />
    }
    else
    {
        <div class="buttons-topOfPage">
            <a href="/" role="button" class="govuk-button govuk-button--secondary" data-module="govuk-button">
                Back to casework
            </a>
            @if (Model.IsEditableCase)
            {
                <a href="@Request.Path/closure" role="button" class="govuk-button govuk-button--warning float__right" id="close-case-button" data-module="govuk-button">
                    Close case
                </a>
            }
        </div>

        <h1 class="govuk-heading-l" name="caseID">
            <span class="govuk-caption-m">Case ID</span>
            @Model.CaseModel.Urn
        </h1>

        <h2 class="govuk-heading-m">@Model.TrustDetailsModel.GiasData.GroupNameTitle</h2>

        <div class="govuk-tabs govuk-!-margin-top-6" data-module="govuk-tabs">

            <ul class="govuk-tabs__list">
                <li class="govuk-tabs__list-item govuk-tabs__list-item--selected">
                    <a class="govuk-tabs__tab" href="#case-details">
                        Case Details
                    </a>
                </li>
                <li class="govuk-tabs__list-item">
                    <a class="govuk-tabs__tab" href="#trust-overview">
                        Trust Overview
                    </a>
                </li>
            </ul>
            <div class="govuk-tabs__panel" id="case-details">

                <!-- Case Details -->
            <table class="govuk-table">
	            <caption class="govuk-table__caption govuk-table__caption--m"></caption>
	            <thead>
	            <tr>
		            <th scope="col" class="govuk-!-width-one-quarter"></th>
		            <th scope="col"></th>
		            <th scope="col"></th>
	            </tr>
	            </thead>
	            <tbody class="govuk-table__body">
	            <tr class="govuk-table__row">
		            <th scope="row" class="govuk-table-case-details__header">Trust</th>
		            <td class="govuk-table__cell">
			            @Model.TrustDetailsModel.GiasData.GroupName
		            </td>
		            <td class="govuk-table__cell govuk-table__header__right"></td>
	            </tr>
                    
	            @if (Model.IsConcernsCase)
	            {
		            <tr class="govuk-table__row">
			            <th scope="row" class="govuk-table-case-details__header">Risk to trust</th>
			            <td class="govuk-table__cell govuk-label-wrapper">
				            @for (var index = 0; index < Model.CaseModel?.RatingModel?.RagRating?.Item2?.Count; ++index)
				            {
					            <span class="govuk-tag ragtag @Model.CaseModel?.RatingModel?.RagRatingCss?.ElementAt(index)">
						            @Model.CaseModel?.RatingModel?.RagRating?.Item2?.ElementAt(index)
					            </span>
				            }
			            </td>
			            <td class="govuk-table__cell govuk-table__header__right">
				            @if (Model.IsEditableCase)
				            {
					            <a class="govuk-link" href="@Request.Path/edit_rating">
						            Edit<span class="govuk-visually-hidden"> risk rating</span>
					            </a>
				            }
			            </td>
		            </tr>
		            <tr class="govuk-table__row">
			            <th scope="row" class="govuk-table-case-details__header">Direction of travel</th>
			            <td class="govuk-table__cell">
				            @Model.CaseModel.DirectionOfTravel
			            </td>
			            <td class="govuk-table__cell govuk-table__header__right">
				            @if (Model.IsEditableCase)
				            {
					            <a class="govuk-link" href="@Request.Path/edit_directionoftravel">
						            Edit<span class="govuk-visually-hidden"> direction of travel</span>
					            </a>
				            }
			            </td>
		            </tr>
	            }
	            <tr class="govuk-table__row">
		            <th scope="row" class="govuk-table-case-details__header">Concerns</th>
		            <td colspan="2" class="govuk-table__cell">
			            @if (Model.CaseModel.RecordsModel.Any())
			            {
				            <table class="govuk-table">
					            <tbody class="govuk-table__body">
					            @foreach (var concern in Model.CaseModel.RecordsModel)
					            {
						            <tr class="govuk-table__row">
							            <td>
								            @concern.TypeModel.TypeDisplay
							            </td>
							            <td>
								            <div class="govuk-ragtag-wrapper govuk-!-padding-bottom-1 govuk-!-padding-right-4">
									            @{
										            if (concern.StatusModel.Name.Equals(StatusEnum.Close.ToString(), StringComparison.OrdinalIgnoreCase))
										            {
											            <span class="govuk-tag ragtag ragtag__grey">
												            Closed
											            </span>
										            }
										            else
										            {
											            for (var index = 0; index < concern.RatingModel.RagRating.Item2.Count; ++index)
											            {
												            <span class="govuk-tag ragtag @concern.RatingModel.RagRatingCss.ElementAt(index)">
													            @concern.RatingModel.RagRating.Item2.ElementAt(index)
												            </span>
											            }
										            }
									            }
								            </div>
							            </td>
							            <td class="govuk-table__header__right">
								            @{
									            if (concern.StatusModel.Name.Equals(StatusEnum.Close.ToString(), StringComparison.OrdinalIgnoreCase))
									            {
										            <br/>
									            }
									            else
									            {
										            <div class="govuk-!-padding-bottom-1">
											            @if (Model.IsEditableCase)
											            {
												            <a class="govuk-link govuk-link-no-visited-state" href="@Request.Path/record/@concern.Id/edit_rating">Edit</a>
											            }
										            </div>
									            }
								            }
							            </td>
						            </tr>
					            }
					            </tbody>
				            </table>
			            }
			            <div class="govuk-o-grid__item--one-half">
				            @if (Model.IsEditableCase)
				            {
					            <a href="@Request.Path/concern" class="govuk-link govuk-link-no-visited-state">Add concern</a>
				            }
			            </div>

		            </td>
		            <td class="govuk-table__cell__no_border"></td>
	            </tr>
	            
	            <tr class="govuk-table__row">
	                <th scope="row" class="govuk-table-case-details__header">SFSO territory</th>
	                <td class="govuk-table__cell">@Model.CaseModel.Territory?.Description()</td>
		            <td class="govuk-table__cell"></td>
	            </tr>
                    
	            </tbody>
            </table>
            
            <h2 class="govuk-heading-m">Concern details</h2>
            <hr class="govuk-section-break govuk-section-break--visible">
	         @if (Model.IsConcernsCase)
	         {
				<table class="govuk-table" id="concern-narratives-default">
		            <caption class="govuk-table__caption govuk-table__caption--m"></caption>
		            <thead>
		            <tr>
			            <th scope="col" class="govuk-!-width-one-quarter"></th>
			            <th scope="col"></th>
		               @if (Model.IsEditableCase)
		               {
			               <th scope="col"></th>
		               }
		            </tr>
		            </thead>
		            <tbody class="govuk-table__body">

		            @* Issue *@
		            <tr class="govuk-table__row">
			            <th scope="row" class="govuk-table-case-details__header">Issue</th>
			            <td class="govuk-table__cell">
				            <span class="dfe-text-area-display">@Model.CaseModel.Issue</span>
			            </td>
			            @if (Model.IsEditableCase)
			            {
				            <td class="govuk-table__cell govuk-table__header__right">
					            <a class="govuk-link float__right" href="@Request.Path/edit_issue">Edit</a>
				            </td>
			            }
		            </tr>
		            
                    @* Current status *@
		            <tr class="govuk-table__row">
			            <th scope="row" class="govuk-table-case-details__header">Current status</th>
			            <td class="govuk-table__cell">
				            <span class="dfe-text-area-display">@Model.CaseModel.CurrentStatus</span>
			            </td>
			            @if (Model.IsEditableCase)
			            {
				            <td class="govuk-table__cell govuk-table__header__right">
					            <a class="govuk-link float__right" href="@Request.Path/edit_current_status">Edit</a>
				            </td>
			            }
		            </tr>
		            
		            @* Case aim *@
		            <tr class="govuk-table__row">
			            <th scope="row" class="govuk-table-case-details__header">Case aim</th>
			            <td class="govuk-table__cell">
				            <span class="dfe-text-area-display">@Model.CaseModel.CaseAim</span>
			            </td>
			            @if (Model.IsEditableCase)
			            {
				            <td class="govuk-table__cell govuk-table__header__right">
					            <a class="govuk-link float__right" href="@Request.Path/edit_case_aim">Edit</a>
				            </td>
			            }
		            </tr>
		                      
		            @* De-escalation point *@
		            <tr class="govuk-table__row">
			            <th scope="row" class="govuk-table-case-details__header">De-escalation point</th>
			            <td class="govuk-table__cell">
				            <span class="dfe-text-area-display">@Model.CaseModel.DeEscalationPoint</span>
			            </td>
			            @if (Model.IsEditableCase)
			            {
				            <td class="govuk-table__cell govuk-table__header__right">
					            <a class="govuk-link float__right" href="@Request.Path/edit_de_escalation_point">Edit</a>
				            </td>
			            }
		            </tr>
		            
		            @* Next steps *@
		            <tr class="govuk-table__row">
			            <th scope="row" class="govuk-table-case-details__header">Next steps</th>
			            <td class="govuk-table__cell">
				            <span class="dfe-text-area-display">@Model.CaseModel.NextSteps</span>
			            </td>
			            @if (Model.IsEditableCase)
			            {
				            <td class="govuk-table__cell govuk-table__header__right">
					            <a class="govuk-link float__right" href="@Request.Path/edit_next_steps">Edit</a>
				            </td>
			            }
		            </tr>
		            		            		                      
		            @* Case history *@
                    <tr class="govuk-table__row">
                        <th scope="row" class="govuk-table-case-details__header">Case history</th>
                        <td class="govuk-table__cell">
                            <span class="dfe-text-area-display">@Model.CaseModel.CaseHistory</span>
                        </td>
                        @if (Model.IsEditableCase)
                        {
                            <td class="govuk-table__cell govuk-table__header__right">
                                <a class="govuk-link float__right" href="@Request.Path/casehistory">Edit</a>
                            </td>
                        }
                    </tr>
				</table>
	         }
            <h3 class="govuk-heading-m">Case actions and decisions</h3>
            <a href="management/action" role="button" class="govuk-button govuk-button--secondary" data-module="govuk-button">
                    Add to case
                </a>

                    <table id="open-case-actions" class="govuk-table">
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row tr__large">
                                <th class="govuk-table__header govuk-table__cell__cases" scope="col">
                                    Active actions and decisions
                                </th>
                                <th class="govuk-table__header govuk-table__cell__cases govuk-table__header__width_15" scope="col">
                                </th>
                                <th class="govuk-table__header govuk-table__cell__cases govuk-table__header__right" scope="col">
                                    Date opened
                                </th>
                            </tr>
                        </thead>

                        <tbody class="govuk-table__body">
	        
	                        @if (!Model.OpenCaseActions.Any())
	                        {
	                            <tr class="govuk-table__row">
	                                <td class="govuk-table__cell" colspan="3">
	                                    There are no open actions or decisions added to this case.
	                                </td>
	                            </tr>
	                        }

							@foreach (ActionSummaryModel action in Model.OpenCaseActions)
							{
								<tr class="govuk-table__row">
									<td class="govuk-table__cell">
									<a href="@action.RelativeUrl" class="govuk-link govuk-link-no-visited-state">
										<span>@action.Name</span>
										</a>
									</td>
									<td class="govuk-table__cell">
										<span>@action.StatusName</span>
									</td>
									<td class="govuk-table__cell govuk-table__header__right">
										@action.OpenedDate
									</td>
								</tr>
							}
                        </tbody>
                    </table>

				<partial name="Shared/_ListClosedActionsForCase" model="Model.ClosedCaseActions" />

            </div>
            <div class="govuk-tabs__panel govuk-tabs__panel--hidden" id="trust-overview">
                <partial name="_TrustOverview" model="@Model.TrustDetailsModel" />
                <partial name="_Academies" model="@Model.TrustDetailsModel.Establishments" />

                <table class="govuk-table  govuk-!-margin-top-9">
                    <caption class="govuk-table__caption govuk-table__caption--m">
                        Active cases
                    </caption>
                    <partial name="_TrustActiveCases" model="@Model.TrustCasesModel" />
                </table>
                <table class="govuk-table  govuk-!-margin-top-9">
                    <caption class="govuk-table__caption govuk-table__caption--m">
                        Closed cases
                    </caption>
                    <partial name="_TrustClosedCases" model="@Model.TrustCasesModel" />
                </table>
            </div>
        </div>

        <script type="application/javascript" nonce="@nonce">
            $(function () {
                $("button[id^='accordion-default-heading']").attr("aria-expanded", "true");
                $(".govuk-accordion__section").addClass("govuk-accordion__section--expanded");

                $(".govuk-tabs__tab").on("click", function(){
                        var url = window.location.href;

                        if(url.includes("#trust-overview")){
                            $("#close-case-button").css("display", "none");
                        }else{
                            $("#close-case-button").css("display", "block");
                        }
                });
            });
        </script>
    }
</div>